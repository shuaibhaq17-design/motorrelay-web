import{y as B,c as b,a as n,k as a,b as s,t as i,e as m,F as A,j as D,h as P,u as te,r as j,l as J,o as se,A as ae,s as K,B as ne,n as F,i as U,g as oe,m as le,p as re,v as ie}from"./index-17v5VSGm.js";async function de(){const{data:y}=await B.get("/messages");return y}async function ue(y){const{data:d}=await B.get(`/messages/threads/${y}`);return d}async function ce(y){const d=new FormData;Object.entries(y).forEach(([w,v])=>{if(v!=null){if(w==="attachments"&&Array.isArray(v)){v.forEach(h=>d.append("attachments[]",h));return}d.append(w,v)}});const{data:u}=await B.post("/messages",d,{headers:{"Content-Type":"multipart/form-data"}});return u}async function fe(y){const{data:d}=await B.post(`/messages/${y}/view`);return d}const pe={class:"w-full overflow-hidden rounded-2xl border border-emerald-100 bg-white shadow"},he={class:"relative h-64 w-full bg-slate-200"},me=["src"],xe={key:1,class:"flex h-full w-full items-center justify-center bg-slate-200 text-sm font-semibold text-slate-600"},be={class:"absolute left-4 top-4 rounded-full bg-white/90 px-3 py-1 text-xs font-semibold text-emerald-700"},ve={class:"space-y-4 p-4"},ge={class:"flex items-start justify-between gap-3"},ye={class:"space-y-1"},_e={class:"text-sm font-semibold text-slate-900"},we={key:0,class:"text-xs text-slate-500"},ke={key:1,class:"text-xs text-slate-500"},$e={key:0,class:"rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-700"},Ce={class:"grid gap-2 text-xs text-slate-500 sm:grid-cols-2"},je={key:0},Ae={key:1},Le={key:0},Me={key:1},Ne={class:"flex flex-wrap gap-2"},De=["href"],Te={__name:"TrackingCard",props:{location:{type:Object,required:!0},destination:{type:Object,default:()=>({})},driver:{type:Object,default:()=>null},etaMinutes:{type:[Number,null],default:null},recordedAt:{type:[String,Number,Date,null],default:null}},setup(y){const d=y,u=b(()=>d.location??{}),w=b(()=>d.destination??{}),v=b(()=>d.driver??null),h=b(()=>{var f,c;return typeof((f=u.value)==null?void 0:f.lat)=="number"&&typeof((c=u.value)==null?void 0:c.lng)=="number"}),k=b(()=>{if(!h.value)return null;const f=u.value.lat,c=u.value.lng;return`https://maps.google.com/maps?q=${f},${c}&z=14&output=embed`}),L=b(()=>{var c,g;return[(c=w.value)==null?void 0:c.label,(g=w.value)==null?void 0:g.postcode].filter(Boolean).join(", ")}),M=b(()=>{const f=L.value;return f?encodeURIComponent(f):""}),N=b(()=>M.value?[{id:"google",label:"Google Maps",href:`https://www.google.com/maps/dir/?api=1&destination=${M.value}&travelmode=driving`},{id:"waze",label:"Waze",href:`https://waze.com/ul?q=${M.value}&navigate=yes`}]:[]),r=b(()=>{if(d.etaMinutes===null||d.etaMinutes===void 0)return null;const f=Number(d.etaMinutes);return Number.isNaN(f)?null:f<=2?"Arriving now":f<=5?`About ${f} minutes away`:`${f} minutes away`}),_=b(()=>{var c,g;if(((c=u.value)==null?void 0:c.speed_kph)===null||((g=u.value)==null?void 0:g.speed_kph)===void 0)return null;const f=Number(u.value.speed_kph);return Number.isNaN(f)?null:`${f.toFixed(0)} km/h`}),T=b(()=>{if(!d.recordedAt)return null;try{return new Intl.DateTimeFormat("en-GB",{hour:"2-digit",minute:"2-digit",day:"numeric",month:"short"}).format(new Date(d.recordedAt))}catch{return d.recordedAt}}),l=b(()=>r.value||"Live location shared");return(f,c)=>(a(),n("article",pe,[s("div",he,[k.value?(a(),n("iframe",{key:0,src:k.value,width:"100%",height:"100%",style:{border:"0"},allowfullscreen:"",loading:"lazy",referrerpolicy:"no-referrer-when-downgrade",title:"Live location map"},null,8,me)):(a(),n("div",xe," Location unavailable ")),s("span",be,i(l.value),1)]),s("div",ve,[s("header",ge,[s("div",ye,[s("p",_e,i(L.value||"Drop-off location"),1),r.value?(a(),n("p",we,i(r.value),1)):(a(),n("p",ke," Updated in real time for the dealer. "))]),v.value?(a(),n("div",$e,i(v.value.name||"Driver"),1)):m("",!0)]),s("dl",Ce,[s("div",null,[c[0]||(c[0]=s("dt",{class:"font-semibold text-slate-700"},"Coordinates",-1)),h.value?(a(),n("dd",je,i(u.value.lat.toFixed(5))+", "+i(u.value.lng.toFixed(5)),1)):(a(),n("dd",Ae,"—"))]),_.value?(a(),n("div",Le,[c[1]||(c[1]=s("dt",{class:"font-semibold text-slate-700"},"Speed",-1)),s("dd",null,i(_.value),1)])):m("",!0),T.value?(a(),n("div",Me,[c[2]||(c[2]=s("dt",{class:"font-semibold text-slate-700"},"Updated",-1)),s("dd",null,i(T.value),1)])):m("",!0)]),s("div",Ne,[(a(!0),n(A,null,D(N.value,g=>(a(),n("a",{key:g.id,href:g.href,target:"_blank",rel:"noopener",class:"inline-flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50"},[P(i(g.label)+" ",1),c[3]||(c[3]=s("span",{"aria-hidden":"true"},"↗",-1))],8,De))),128))])])]))}},Se={class:"grid gap-4 lg:grid-cols-[320px,1fr]"},Fe={class:"space-y-3 rounded-2xl border bg-white p-4"},Be={key:0,class:"rounded-xl border bg-slate-50 p-3 text-sm text-slate-600"},Ee={key:1,class:"rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-700"},ze={key:2,class:"space-y-2"},Ie=["onClick"],Ue={class:"flex items-center justify-between gap-2"},Pe={class:"text-sm font-semibold text-slate-900"},Ve={key:0,class:"badge bg-emerald-500 text-white"},Oe={class:"text-xs text-slate-500"},qe={class:"line-clamp-2 text-xs text-slate-500"},Re={class:"space-y-4 rounded-2xl border bg-white p-4"},We={key:0},Ge={class:"space-y-1 border-b pb-3"},He={class:"flex items-center justify-between gap-2"},Je={class:"text-lg font-semibold text-slate-900"},Ke={class:"text-xs text-slate-500"},Qe={key:0},Xe={key:0,class:"badge bg-slate-100 text-slate-700"},Ye={key:0,class:"rounded-xl border bg-slate-50 p-4 text-sm text-slate-600"},Ze={key:1,class:"rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-700"},et={key:0,class:"text-sm text-slate-600"},tt={key:0},st={key:1,class:"mt-2 flex flex-wrap gap-2"},at=["onClick"],nt=["src","alt"],ot=["href"],lt={key:0},rt={key:1},it={class:"flex flex-wrap items-center justify-between gap-3 text-xs text-slate-500"},dt={class:"flex items-center gap-2"},ut={key:0},ct={key:0,class:"text-sm text-amber-600"},ft={class:"flex justify-end"},pt=["disabled"],ht={key:0},mt={key:1},xt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80 p-4"},bt={class:"flex max-h-[80vh] w-full max-w-4xl flex-col items-center gap-3"},vt=["src","alt"],gt={class:"text-sm text-white"},_t={__name:"MessagesInbox",setup(y){const d=te(),u=j([]),w=j(!1),v=j(""),h=j(null),k=j([]),L=j(null),M=j(!1),N=j(""),r=J({body:"",attachments:[],sending:!1,error:""}),_=b(()=>u.value.find(t=>t.id===h.value)??null),T=b(()=>{var t;return(((t=_.value)==null?void 0:t.participants)??[]).filter(o=>{var e;return o.id!==((e=d.user)==null?void 0:e.id)})}),l=J({open:!1,index:0,items:[]});function f(t){return String((t==null?void 0:t.mime_type)||"").startsWith("image/")}function c(t){var o,e;return!!(((o=t==null?void 0:t.meta)==null?void 0:o.type)==="location_update"&&((e=t.meta)!=null&&e.location))}se(async()=>{!d.user&&d.token&&await d.fetchMe().catch(()=>null),await g()}),ae(()=>{l.open&&(document.body.style.overflow="",window.removeEventListener("keydown",z))});async function g(){w.value=!0,v.value="";try{const t=await de();u.value=Array.isArray(t==null?void 0:t.data)?t.data:[],!h.value&&u.value.length?await E(u.value[0].id):h.value&&!u.value.find(e=>e.id===h.value)&&u.value.length&&await E(u.value[0].id)}catch(t){console.error("Failed to load conversations",t),v.value="Unable to load conversations right now.",u.value=[]}finally{w.value=!1}}async function E(t){h.value!==t&&(h.value=t,await Q(t))}async function Q(t=h.value){if(t){M.value=!0,N.value="";try{const o=await ue(t);k.value=Array.isArray(o==null?void 0:o.data)?o.data:[],await R(),W()}catch(o){console.error("Failed to load messages",o),N.value="Unable to load messages right now.",k.value=[]}finally{M.value=!1}}}function X(t){const o=Array.from(t.target.files??[]);r.attachments=o,t.target.value=""}function Y(t,o){const e=t.filter(f),p=e.findIndex(x=>x.id===o.id);!e.length||p===-1||(l.items=e,l.index=p,l.open=!0,document.body.style.overflow="hidden")}function V(){l.open=!1,l.items=[],l.index=0,document.body.style.overflow=""}function O(){l.items.length&&(l.index=(l.index+1)%l.items.length)}function q(){l.items.length&&(l.index=(l.index-1+l.items.length)%l.items.length)}function z(t){l.open&&(t.key==="Escape"?(t.preventDefault(),V()):t.key==="ArrowRight"?(t.preventDefault(),O()):t.key==="ArrowLeft"&&(t.preventDefault(),q()))}K(()=>l.open,t=>{t?window.addEventListener("keydown",z):window.removeEventListener("keydown",z)});function I(t,o){var e;return((e=t.receipts)==null?void 0:e.find(p=>p.user_id===o))??null}async function R(){var e;const t=(e=d.user)==null?void 0:e.id;if(!t)return;const o=k.value.filter(p=>{const x=I(p,t);return x&&!x.viewed_at&&p.user.id!==t});await Promise.all(o.map(async p=>{try{const{viewed_at:x}=await fe(p.id),C=I(p,t);C&&(C.viewed_at=x)}catch(x){console.error("Failed to mark message as viewed",x)}}))}async function Z(){var t,o;if(!(!h.value||r.sending)){if(!r.body&&r.attachments.length===0){r.error="Add a message or an attachment before sending.";return}r.error="",r.sending=!0;try{const e={thread_id:h.value};r.body.trim()&&(e.body=r.body),r.attachments.length&&(e.attachments=r.attachments);const p=await ce(e),{thread:x,message:C}=p||{};C&&(k.value.push(C),W()),x&&ee(x),r.body="",r.attachments=[],await R()}catch(e){console.error("Failed to send message",e),r.error=((o=(t=e.response)==null?void 0:t.data)==null?void 0:o.message)||"Unable to send your message."}finally{r.sending=!1}}}K(h,()=>{r.body="",r.attachments=[],r.error=""});function ee(t){if(!t)return;const o=u.value.findIndex(p=>p.id===t.id);if(o===-1){u.value.unshift(t);return}const e={...u.value[o],...t};u.value.splice(o,1),u.value.unshift(e)}function W(){ne(()=>{L.value&&(L.value.scrollTop=L.value.scrollHeight)})}return(t,o)=>(a(),n("div",Se,[s("section",Fe,[o[1]||(o[1]=s("header",null,[s("h1",{class:"text-lg font-semibold text-slate-900"},"Conversations"),s("p",{class:"text-xs text-slate-500"},"Dealers and drivers can chat once a job is in progress.")],-1)),w.value?(a(),n("div",Be," Loading conversations... ")):v.value?(a(),n("p",Ee,i(v.value),1)):(a(),n("ol",ze,[(a(!0),n(A,null,D(u.value,e=>(a(),n("li",{key:e.id},[s("button",{type:"button",class:F(["flex w-full flex-col gap-1 rounded-xl border px-3 py-2 text-left transition hover:-translate-y-0.5 hover:shadow",h.value===e.id?"border-emerald-200 bg-emerald-50":"border-slate-200 bg-white"]),onClick:p=>E(e.id)},[s("div",Ue,[s("h2",Pe,i(e.subject||"Conversation"),1),e.unread_count?(a(),n("span",Ve,i(e.unread_count),1)):m("",!0)]),s("p",Oe,i(e.updated_at?new Date(e.updated_at).toLocaleString():"--"),1),s("p",qe,i(e.last_message||"No messages yet."),1)],10,Ie)]))),128))]))]),s("section",Re,[_.value?(a(),n(A,{key:1},[s("header",Ge,[s("div",He,[s("div",null,[s("h2",Je,i(_.value.subject||"Conversation"),1),s("p",Ke,[o[3]||(o[3]=P(" Participants: ",-1)),(a(!0),n(A,null,D(_.value.participants,(e,p)=>(a(),n("span",{key:e.id},[P(i(e.name),1),p<_.value.participants.length-1?(a(),n("span",Qe,", ")):m("",!0)]))),128))])]),_.value.job_id?(a(),n("span",Xe," Job #"+i(_.value.job_id),1)):m("",!0)])]),M.value?(a(),n("div",Ye," Loading messages... ")):N.value?(a(),n("div",Ze,i(N.value),1)):(a(),n("div",{key:2,ref_key:"messageContainer",ref:L,class:"flex h-[420px] flex-col gap-3 overflow-y-auto rounded-xl border border-slate-200 bg-slate-50 p-4"},[k.value.length?m("",!0):(a(),n("p",et," No messages yet. Start the conversation below. ")),(a(!0),n(A,null,D(k.value,e=>{var p,x,C,G,H;return a(),n("article",{key:e.id,class:F(["flex w-full flex-col gap-2",c(e)?"items-stretch":e.user.id===((p=U(d).user)==null?void 0:p.id)?"items-end":"items-start"])},[c(e)?(a(),oe(Te,{key:0,location:e.meta.location,destination:e.meta.destination,driver:e.meta.driver,"eta-minutes":e.meta.eta_minutes??null,"recorded-at":((x=e.meta.location)==null?void 0:x.recorded_at)??e.created_at},null,8,["location","destination","driver","eta-minutes","recorded-at"])):(a(),n("div",{key:1,class:F(["max-w-[80%] rounded-2xl px-3 py-2 text-sm shadow-sm",e.user.id===((C=U(d).user)==null?void 0:C.id)?"bg-emerald-600 text-white":"bg-white text-slate-800"])},[e.body?(a(),n("p",tt,i(e.body),1)):m("",!0),(G=e.attachments)!=null&&G.length?(a(),n("div",st,[(a(!0),n(A,null,D(e.attachments,$=>(a(),n(A,{key:$.id},[f($)?(a(),n("button",{key:0,type:"button",class:"overflow-hidden rounded-xl border border-white/40 bg-white/10",onClick:S=>Y(e.attachments,$)},[s("img",{src:$.url,alt:$.original_name,class:"h-24 w-24 object-cover",loading:"lazy"},null,8,nt)],8,at)):(a(),n("a",{key:1,href:$.url,target:"_blank",class:"inline-flex items-center gap-2 rounded-xl border border-white/40 bg-white/10 px-3 py-2 text-xs font-semibold text-white underline-offset-2 hover:underline"},i($.original_name),9,ot))],64))),128))])):m("",!0)],2)),s("div",{class:F(["flex items-center gap-2 text-[11px] text-slate-500",c(e)?"self-start":""])},[s("span",null,i(e.user.name),1),o[4]||(o[4]=s("span",null,"-",-1)),s("time",null,i(new Date(e.created_at).toLocaleString()),1),e.user.id===((H=U(d).user)==null?void 0:H.id)?(a(),n(A,{key:0},[T.value.some($=>{const S=I(e,$.id);return S==null?void 0:S.viewed_at})?(a(),n("span",lt," Viewed ")):(a(),n("span",rt,"Delivered"))],64)):m("",!0)],2)],2)}),128))],512)),s("form",{class:"space-y-3 rounded-2xl border border-slate-200 bg-slate-50 p-4",onSubmit:le(Z,["prevent"])},[o[6]||(o[6]=s("label",{class:"text-xs font-semibold uppercase tracking-wide text-slate-500",for:"message-body"}," Message ",-1)),re(s("textarea",{id:"message-body","onUpdate:modelValue":o[0]||(o[0]=e=>r.body=e),rows:"3",class:"w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200",placeholder:"Write your update..."},null,512),[[ie,r.body]]),s("div",it,[s("label",dt,[s("input",{type:"file",multiple:"",accept:".png,.jpg,.jpeg,.pdf",class:"hidden",onChange:X},null,32),o[5]||(o[5]=s("span",{class:"rounded-xl border border-slate-200 px-3 py-1 font-semibold text-slate-700 hover:bg-slate-100"}," Attach files ",-1))]),r.attachments.length?(a(),n("span",ut,i(r.attachments.length)+" file(s) ready",1)):m("",!0)]),r.error?(a(),n("p",ct,i(r.error),1)):m("",!0),s("div",ft,[s("button",{type:"submit",class:"rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:cursor-not-allowed disabled:opacity-60",disabled:r.sending},[r.sending?(a(),n("span",ht,"Sending...")):(a(),n("span",mt,"Send"))],8,pt)])],32)],64)):(a(),n("div",We,[...o[2]||(o[2]=[s("h2",{class:"text-lg font-semibold text-slate-900"},"Select a conversation",-1),s("p",{class:"text-sm text-slate-600"},"Choose a thread to review messages and send updates.",-1)])]))]),l.open&&l.items.length?(a(),n("div",xt,[s("button",{type:"button",class:"absolute right-4 top-4 rounded-full bg-white/90 px-3 py-1 text-sm font-semibold text-slate-700 shadow hover:bg-white",onClick:V}," Close "),l.items.length>1?(a(),n("button",{key:0,type:"button",class:"absolute left-4 top-1/2 -translate-y-1/2 rounded-full bg-white/80 px-3 py-2 text-sm font-semibold text-slate-700 shadow hover:bg-white",onClick:q}," Prev ")):m("",!0),s("figure",bt,[s("img",{src:l.items[l.index].url,alt:l.items[l.index].original_name,class:"max-h-[70vh] w-auto max-w-full rounded-2xl object-contain shadow-2xl"},null,8,vt),s("figcaption",gt,i(l.items[l.index].original_name)+" ("+i(l.index+1)+" / "+i(l.items.length)+") ",1)]),l.items.length>1?(a(),n("button",{key:1,type:"button",class:"absolute right-4 top-1/2 -translate-y-1/2 rounded-full bg-white/80 px-3 py-2 text-sm font-semibold text-slate-700 shadow hover:bg-white",onClick:O}," Next ")):m("",!0)])):m("",!0)]))}};export{_t as default};
