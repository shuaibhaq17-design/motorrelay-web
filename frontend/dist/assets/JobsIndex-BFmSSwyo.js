import{u as ae,r as u,l as K,c as y,o as le,a as n,b as o,e as r,g as T,i as d,w as x,h as p,R as v,t as i,f as S,F as k,j as H,m as ne,p as ie,v as re,q as de,k as a}from"./index-17v5VSGm.js";import{a as $,m as ce,s as ue,c as pe,b as be}from"./jobs-rqOJ3JE0.js";const me={class:"grid gap-6 lg:grid-cols-[3fr_1fr]"},xe={class:"space-y-4"},ve={class:"flex flex-col justify-between gap-3 md:flex-row md:items-center"},fe={class:"flex flex-wrap items-center gap-2"},he={key:0,class:"text-sm text-amber-600"},ye={key:1,class:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm"},_e={class:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between"},ge={key:2,class:"rounded-2xl border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-700"},we={key:3,class:"rounded-2xl border bg-white p-4 text-sm text-slate-600"},ke={key:4,class:"space-y-3"},Ce={class:"flex items-center justify-between"},Ae={class:"text-lg font-semibold text-slate-900"},Je={key:0,class:"rounded-xl border border-amber-200 bg-amber-50 p-3 text-xs text-amber-700"},De={key:1,class:"rounded-2xl border bg-white p-4 text-sm text-slate-600"},je={key:2,class:"rounded-2xl border border-dashed border-slate-200 bg-slate-50 p-4 text-sm text-slate-600"},Le={key:3,class:"space-y-4"},Me={class:"flex flex-wrap items-start justify-between gap-3"},Te={class:"text-lg font-semibold text-slate-900"},Se={class:"text-sm text-slate-600"},Ne={class:"text-xs text-slate-500"},Fe={class:"text-xs text-slate-500"},Ie={key:0},Ve={key:1},$e={class:"text-right"},Pe={class:"text-lg font-bold text-emerald-600"},Be={class:"badge bg-emerald-100 text-emerald-700"},Re={key:0,class:"rounded-xl border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700"},Ge={class:"flex flex-wrap gap-2"},We=["onClick"],Ee=["disabled","onClick"],Oe={key:0},Ue={key:1},Ye=["disabled","onClick"],qe={key:0},ze={key:1},Ke={class:"rounded-2xl border border-dashed border-slate-200 bg-slate-50 p-4 text-xs text-slate-600"},He={class:"space-y-3"},Qe={key:0,class:"flex items-center justify-between"},Xe={class:"text-xs font-semibold text-slate-500"},Ze={key:1,class:"rounded-2xl border bg-white p-4 text-sm text-slate-600"},et={key:2,class:"rounded-2xl border bg-white p-4 text-sm text-slate-600"},tt={key:3,class:"space-y-4"},st=["onClick"],ot={class:"flex items-start justify-between gap-3"},at={class:"text-lg font-semibold text-slate-900"},lt={class:"text-sm text-slate-600"},nt={class:"text-xs text-slate-500"},it={class:"text-xs text-slate-500"},rt={class:"badge bg-slate-100 text-slate-800"},dt={class:"mt-3 flex flex-wrap gap-2"},ct=["disabled","onClick"],ut={key:0},pt={key:1},bt={class:"space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm"},mt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 p-4"},xt={class:"w-full max-w-md rounded-2xl bg-white p-6 shadow-xl"},vt={class:"text-lg font-semibold text-slate-900"},ft={class:"mt-3 text-sm text-slate-600"},ht={key:0,class:"mt-4 space-y-2"},yt={class:"mt-6 flex justify-end gap-2"},_t=["disabled"],gt=["disabled"],wt={key:0},kt={key:1},Dt={__name:"JobsIndex",setup(Ct){const b=ae(),Q=de(),C=u([]),_=u([]),N=u([]),A=u(!1),g=u(!1),F=u(!1),J=u(""),D=u(""),P=u(""),j=u(""),w=u(new Set),h=K({id:null,type:null}),l=K({open:!1,job:null,mode:null,message:"",pending:!1,note:""}),B=new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0});async function R(){j.value="",A.value=!0,V.value?g.value=!0:(g.value=!1,_.value=[]),E.value?F.value=!0:(F.value=!1,N.value=[]),J.value="",D.value="",P.value="";try{const e=await $({scope:"available"}),s=(Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e==null?void 0:e.jobs)?e.jobs:[]).filter(c=>String(c.status||"").toLowerCase()==="open");if(C.value=s,m.value){const c=C.value.filter(f=>f.my_application&&f.my_application.status!=="declined").map(f=>f.id);w.value=new Set(c)}}catch(e){console.error("Failed to load jobs",e),J.value="Unable to load jobs right now.",C.value=[]}finally{A.value=!1}if(V.value)try{const e=await $({scope:"current"}),t=Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e==null?void 0:e.jobs)?e.jobs:[];_.value=t}catch(e){console.error("Failed to load active jobs",e),D.value="We could not load active jobs right now.",_.value=[]}finally{g.value=!1}if(E.value)try{const e=await $({scope:"completed"}),t=Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e==null?void 0:e.jobs)?e.jobs:[];N.value=t}catch(e){console.error("Failed to load completed jobs",e),P.value="We could not load completed jobs right now.",N.value=[]}finally{F.value=!1}}async function X(e){var t,s;if(!w.value.has(e.id))try{await be(e.id),w.value=new Set([...w.value,e.id])}catch(c){console.error("Job application failed",c),alert(((s=(t=c.response)==null?void 0:t.data)==null?void 0:s.message)||"We could not submit your application. Please try again.")}}function G(e){Q.push({name:"job-detail",params:{id:e.id}})}function W(e){if(!(e!=null&&e.goes_live_at))return!1;const t=new Date(e.goes_live_at);return!Number.isNaN(t.getTime())&&t.getTime()>Date.now()}function Z(e){return W(e)?new Intl.DateTimeFormat("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}).format(new Date(e.goes_live_at)):""}const L=y(()=>C.value??[]),m=y(()=>b.role==="driver"),I=y(()=>b.role==="dealer"),ee=y(()=>b.role==="admin"),V=y(()=>m.value||I.value||ee.value),E=y(()=>!1);function O(e){return w.value.has(e)}function M(e,t){return h.id===e&&h.type===t}async function te(e){U(e,"cancel")}async function se(e){U(e,"deliver")}function U(e,t){l.job=e,l.mode=t,l.open=!0,l.pending=!1,t==="deliver"?l.message="Mark this job as delivered? The dealer will be notified.":t==="invoice"?l.message="Send the invoice for this job to the dealer? They will be able to download it immediately.":l.message=m.value?"Cancel this job? It will return to the board for other drivers. Add an optional note below.":"Cancel this job? This will withdraw the job from the assigned driver and close it. Add an optional note below.",l.note=""}async function oe(){var e,t;if(!(!l.job||!l.mode)){l.pending=!0,h.id=l.job.id,h.type=l.mode;try{let s="";if(l.mode==="deliver")await ce(l.job.id),s="Job marked as delivered.";else if(l.mode==="invoice")await ue(l.job.id),s="Invoice sent to the dealer.";else{const c=l.note?{reason:l.note}:{};await pe(l.job.id,c),s="Job cancelled."}await R(),j.value=s,Y()}catch(s){console.error("Job action failed",s),alert(((t=(e=s.response)==null?void 0:e.data)==null?void 0:t.message)||"We could not complete this action. Please try again."),l.pending=!1}finally{h.id=null,h.type=null}}}function Y(){l.open=!1,l.job=null,l.mode=null,l.message="",l.note="",l.pending=!1}function q(e){const t=(e||"").toString().toLowerCase();return t==="trailer"?"Trailer":t==="drive_away"?"Drive-away":e||"--"}return le(async()=>{!b.user&&b.token&&await b.fetchMe().catch(()=>null),await R()}),(e,t)=>(a(),n(k,null,[o("div",me,[o("div",xe,[o("div",ve,[t[3]||(t[3]=o("div",null,[o("h1",{class:"text-2xl font-bold text-slate-900"},"Jobs"),o("p",{class:"text-sm text-slate-600"},"Review and manage MotorRelay runs.")],-1)),o("div",fe,[d(b).isDealer||d(b).role==="admin"?(a(),T(d(v),{key:0,to:"/jobs/new",class:"rounded-xl border border-slate-200 px-3 py-2 text-sm font-semibold hover:bg-slate-50"},{default:x(()=>[...t[1]||(t[1]=[p(" + Create Job ",-1)])]),_:1})):r("",!0),d(b).hasPlannerAccess?(a(),T(d(v),{key:1,to:"/planner",class:"rounded-xl border border-slate-200 px-3 py-2 text-sm font-semibold hover:bg-slate-50"},{default:x(()=>[...t[2]||(t[2]=[p(" Planner ",-1)])]),_:1})):r("",!0)])]),J.value?(a(),n("p",he,i(J.value),1)):r("",!0),d(b).hasPlannerAccess?(a(),n("section",ye,[o("div",_e,[t[5]||(t[5]=o("div",null,[o("h2",{class:"text-lg font-semibold text-slate-900"},"Planner"),o("p",{class:"text-sm text-slate-600"}," Coordinate routes and reserve driver time before posting or assigning new runs. ")],-1)),S(d(v),{to:"/planner",class:"inline-flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50"},{default:x(()=>[...t[4]||(t[4]=[p(" Open planner ",-1),o("span",{"aria-hidden":"true"},"→",-1)])]),_:1})])])):r("",!0),j.value?(a(),n("p",ge,i(j.value),1)):r("",!0),A.value&&!g.value?(a(),n("div",we," Loading jobs… ")):r("",!0),V.value?(a(),n("section",ke,[o("header",Ce,[o("h2",Ae,i(m.value?"Your active jobs":"Active jobs"),1),m.value?(a(),T(d(v),{key:0,to:"/driver",class:"text-xs font-semibold text-emerald-600 hover:underline"},{default:x(()=>[...t[6]||(t[6]=[p(" Driver dashboard ",-1)])]),_:1})):r("",!0)]),D.value?(a(),n("p",Je,i(D.value),1)):r("",!0),g.value?(a(),n("div",De," Loading your active jobs... ")):_.value.length?(a(),n("div",Le,[(a(!0),n(k,null,H(_.value,s=>{var c,f;return a(),n("article",{key:`active-${s.id}`,class:"tile flex flex-col gap-3 p-6"},[o("div",Me,[o("div",null,[o("p",Te,i(s.title||`Job #${s.id}`),1),o("p",Se,i(s.pickup_postcode||"--")+" -> "+i(s.dropoff_postcode||"--"),1),o("p",Ne," Transport: "+i(q(s.transport_type)),1),o("p",Fe,[m.value?(a(),n(k,{key:0},[p(i((c=s.posted_by)!=null&&c.name?`Dealer: ${s.posted_by.name}`:"Dealer"),1)],64)):(a(),n(k,{key:1},[(f=s.assigned_to)!=null&&f.name?(a(),n("span",Ie,"Driver: "+i(s.assigned_to.name),1)):(a(),n("span",Ve,"Awaiting driver assignment"))],64))])]),o("div",$e,[o("div",Pe,i(d(B).format(Number(s.price??0))),1),o("span",Be,i(s.status),1)])]),I.value&&W(s)?(a(),n("p",Re," Goes live at "+i(Z(s))+". You can still edit this job if needed. ",1)):r("",!0),o("div",Ge,[o("button",{type:"button",class:"rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50",onClick:z=>G(s)}," View details ",8,We),I.value?(a(),T(d(v),{key:0,to:`/jobs/${s.id}/edit`,class:"rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50"},{default:x(()=>[...t[7]||(t[7]=[p(" Edit job ",-1)])]),_:1},8,["to"])):r("",!0),o("button",{type:"button",class:"rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-60",disabled:M(s.id,"cancel"),onClick:z=>te(s)},[M(s.id,"cancel")?(a(),n("span",Oe,"Cancelling...")):(a(),n("span",Ue,"Cancel job"))],8,Ee),m.value?(a(),n("button",{key:1,type:"button",class:"rounded-xl bg-emerald-600 px-3 py-2 text-xs font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",disabled:M(s.id,"deliver"),onClick:z=>se(s)},[M(s.id,"deliver")?(a(),n("span",qe,"Updating...")):(a(),n("span",ze,"Mark as delivered"))],8,Ye)):r("",!0)])])}),128))])):(a(),n("div",je," You have no active jobs right now. "))])):r("",!0),o("div",Ke,[t[9]||(t[9]=p(" Looking for historical runs? ",-1)),S(d(v),{to:"/profile",class:"font-semibold text-emerald-600 hover:underline"},{default:x(()=>[...t[8]||(t[8]=[p("View completed jobs in your profile",-1)])]),_:1}),t[10]||(t[10]=p(". ",-1))]),o("section",He,[m.value?(a(),n("header",Qe,[t[11]||(t[11]=o("h2",{class:"text-lg font-semibold text-slate-900"},"Available jobs",-1)),o("span",Xe,i(L.value.length)+" listed ",1)])):r("",!0),A.value&&!L.value.length?(a(),n("div",Ze," Loading jobs... ")):L.value.length?(a(),n("div",tt,[(a(!0),n(k,null,H(L.value,s=>(a(),n("button",{key:s.id,type:"button",class:"tile w-full cursor-pointer text-left p-6 transition hover:-translate-y-0.5 hover:shadow-md",onClick:c=>G(s)},[o("div",ot,[o("div",null,[o("div",at,i(d(B).format(Number(s.price??0))),1),o("p",lt,i(s.company||"Customer")+" - "+i(s.vehicle_make||"Vehicle"),1),o("p",nt,i(s.pickup_postcode||"--")+" -> "+i(s.dropoff_postcode||"--"),1),o("p",it," Transport: "+i(q(s.transport_type)),1)]),o("span",rt,i(s.status),1)]),o("div",dt,[m.value?(a(),n("button",{key:0,type:"button",class:"rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",disabled:O(s.id),onClick:ne(c=>X(s),["stop"])},[O(s.id)?(a(),n("span",ut,"Application sent")):(a(),n("span",pt,"Request this job"))],8,ct)):r("",!0)])],8,st))),128))])):(a(),n("div",et," No jobs here yet. "))])]),o("aside",bt,[t[14]||(t[14]=o("h2",{class:"text-sm font-semibold text-slate-900"},"Job tips",-1)),t[15]||(t[15]=o("p",{class:"text-sm text-slate-600"}," Keep your pipeline organised: move delivered runs to invoices immediately and reserve capacity in the planner. ",-1)),S(d(v),{to:"/profile/completed",class:"inline-flex items-center justify-center rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm font-semibold text-emerald-700 transition hover:bg-emerald-100"},{default:x(()=>[...t[12]||(t[12]=[p(" View completed jobs ",-1)])]),_:1}),S(d(v),{to:"/planner",class:"inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50"},{default:x(()=>[...t[13]||(t[13]=[p(" Open planner ",-1)])]),_:1})])]),l.open?(a(),n("div",mt,[o("div",xt,[o("h3",vt,i(l.mode==="deliver"?"Mark job as delivered":l.mode==="invoice"?"Send invoice":"Cancel job"),1),o("p",ft,i(l.message),1),l.mode==="cancel"?(a(),n("div",ht,[t[16]||(t[16]=o("label",{class:"text-xs font-semibold uppercase tracking-wide text-slate-500"}," Optional note ",-1)),ie(o("textarea",{"onUpdate:modelValue":t[0]||(t[0]=s=>l.note=s),rows:"3",class:"w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200",placeholder:"Let them know why you're cancelling"},null,512),[[re,l.note]])])):r("",!0),o("div",yt,[o("button",{type:"button",class:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-60",disabled:l.pending,onClick:Y}," Close ",8,_t),o("button",{type:"button",class:"rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",disabled:l.pending,onClick:oe},[l.pending?(a(),n("span",wt,"Working...")):(a(),n("span",kt,"Confirm"))],8,gt)])])])):r("",!0)],64))}};export{Dt as default};
