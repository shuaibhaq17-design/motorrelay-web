import{u as at,r as p,l as me,c,o as ot,s as Ue,a as n,f as ve,w as X,h as _,i as Z,R as be,t as r,b as t,e as u,g as lt,F as ee,j as te,m as xe,p as se,v as ae,n as Te,T as nt,z as it,k as l}from"./index-17v5VSGm.js";import{d as rt,e as dt,u as ut,g as ct,h as pt,r as mt,i as vt,j as bt,k as xt,l as ft,n as _t,o as gt,p as yt,q as ht,t as wt}from"./jobs-rqOJ3JE0.js";const kt={class:"space-y-4"},jt={key:0,class:"rounded-2xl border bg-white p-4 text-sm text-slate-600"},Ct={key:1,class:"rounded-2xl border bg-white p-4 text-sm text-amber-600"},Dt={key:2,class:"rounded-2xl border bg-white p-4 text-sm text-slate-600"},St={key:3,class:"space-y-4"},Lt={class:"flex flex-col items-start justify-between gap-3 rounded-2xl border bg-white p-6 md:flex-row md:items-center"},Ft={class:"text-2xl font-bold text-slate-900"},At={class:"text-sm text-slate-600"},Et={class:"text-right"},Ut={class:"text-3xl font-extrabold text-emerald-600"},Tt={class:"badge bg-slate-100 text-slate-800"},Nt={key:0,class:"rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-800"},Rt={class:"font-semibold text-amber-900 flex items-center justify-between gap-3"},$t={class:"mt-1"},Bt={class:"grid gap-4 lg:grid-cols-3"},Jt={class:"tile p-4"},Pt={class:"text-lg font-bold text-slate-900"},Mt={class:"text-sm text-slate-600"},Vt={class:"mt-3 text-sm text-slate-500"},zt={class:"tile p-4"},Gt={class:"text-lg font-bold text-slate-900"},It={class:"text-sm text-slate-600"},Ot={class:"mt-3 text-sm text-slate-500"},qt={class:"tile space-y-2 p-4"},Wt={class:"flex items-center justify-between"},Yt={class:"text-base font-semibold text-slate-900"},Kt={class:"flex items-center justify-between"},Ht={class:"text-base font-semibold text-slate-900"},Qt={class:"flex items-center justify-between"},Xt={class:"text-base font-semibold text-slate-900"},Zt={class:"tile p-4"},es={class:"mt-2 text-sm text-slate-600"},ts={class:"mt-4 space-y-2"},ss={id:"job-driver-select",class:"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm font-semibold text-slate-700",disabled:""},as=["value"],os={key:1,value:"unassigned"},ls={key:0,class:"mt-4 flex flex-wrap items-center gap-3 rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-xs text-emerald-800"},ns=["disabled"],is={key:0},rs={key:1},ds={key:1,class:"tile space-y-3 p-4"},us={class:"flex flex-wrap gap-3"},cs=["disabled"],ps={key:0},ms={key:1},vs={key:0,class:"text-xs text-rose-600"},bs={key:1,class:"text-xs text-slate-500"},xs={key:2,class:"tile space-y-4 p-4"},fs={class:"flex flex-wrap items-center justify-between gap-3"},_s={class:"rounded-full bg-emerald-100 px-3 py-0.5 text-xs font-semibold uppercase tracking-wide text-emerald-700"},gs={class:"grid gap-4 sm:grid-cols-3"},ys={class:"text-2xl font-bold text-slate-900"},hs={class:"text-2xl font-bold text-slate-900"},ws={class:"mt-1 space-y-1 text-xs text-slate-500"},ks={key:3,class:"tile space-y-4 p-4"},js={class:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between"},Cs={class:"flex flex-wrap gap-3 text-xs text-slate-500"},Ds={class:"font-semibold text-slate-800"},Ss={class:"font-semibold text-emerald-700"},Ls={class:"font-semibold text-slate-800"},Fs={key:0,class:"rounded-xl border border-amber-200 bg-amber-50 p-3 text-xs text-amber-700"},As={class:"md:col-span-2"},Es={class:"md:col-span-2"},Us={class:"md:col-span-2 flex items-end justify-end gap-2"},Ts=["disabled"],Ns={key:0},Rs={key:1},$s={key:0,class:"md:col-span-4 text-xs text-amber-700"},Bs={key:2,class:"rounded-xl border bg-slate-50 p-4 text-sm text-slate-600"},Js={key:3,class:"rounded-xl border border-dashed border-slate-200 bg-slate-50 p-4 text-sm text-slate-600"},Ps={key:4,class:"space-y-3"},Ms={class:"flex flex-wrap items-start justify-between gap-3"},Vs={class:"text-sm font-semibold text-slate-900"},zs={class:"text-xs text-slate-500"},Gs={key:0},Is={class:"mt-3 grid gap-2 text-xs text-slate-600 sm:grid-cols-3"},Os={class:"font-semibold text-slate-900"},qs={class:"uppercase tracking-wide"},Ws={class:"font-semibold text-slate-900"},Ys={class:"font-semibold text-slate-900"},Ks={key:0,class:"mt-2 rounded-xl bg-slate-50 p-3 text-xs text-slate-600"},Hs={class:"mt-3 flex flex-wrap gap-2"},Qs=["disabled","onClick"],Xs={key:0},Zs={key:1},ea=["onClick"],ta=["onClick"],sa=["onClick"],aa=["onClick"],oa={key:4,class:"tile space-y-4 p-4"},la={class:"flex flex-col gap-1 md:flex-row md:items-center md:justify-between"},na={class:"badge bg-slate-100 text-slate-800 uppercase"},ia={class:"grid gap-3 text-xs text-slate-600 sm:grid-cols-2"},ra={class:"text-sm font-semibold text-slate-900"},da={class:"text-sm font-semibold text-slate-900"},ua={class:"text-sm font-semibold text-slate-900"},ca={class:"text-sm text-slate-900"},pa={key:0,class:"rounded-xl border border-amber-200 bg-amber-50 p-3 text-xs text-amber-700"},ma={class:"md:col-span-2"},va={class:"md:col-span-2"},ba={class:"md:col-span-2 flex justify-end"},xa=["disabled"],fa={key:0},_a={key:1},ga={key:2,class:"flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs text-slate-600"},ya={class:"text-sm text-slate-900"},ha=["disabled"],wa={key:0},ka={key:1},ja={key:3,class:"flex flex-wrap gap-2"},Ca=["disabled"],Da={key:0},Sa={key:1},La=["disabled"],Fa={key:4,class:"rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-xs text-emerald-700"},Aa={key:5,class:"tile space-y-3 p-4"},Ea={class:"text-sm text-slate-600"},Ua={class:"font-semibold text-slate-900"},Ta={key:0,class:"text-xs text-slate-500"},Na={key:0,class:"text-sm text-slate-600"},Ra={key:6,class:"tile space-y-4 p-4"},$a={class:"flex items-center justify-between"},Ba={class:"badge bg-slate-100 text-slate-800"},Ja={key:0,class:"rounded-xl border bg-slate-50 p-4 text-sm text-slate-600"},Pa={key:1,class:"rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-700"},Ma={key:2,class:"rounded-xl border bg-slate-50 p-4 text-sm text-slate-600"},Va={key:3,class:"space-y-3"},za={class:"flex flex-wrap items-center justify-between gap-3"},Ga={class:"text-sm font-semibold text-slate-900"},Ia={class:"text-xs text-slate-500"},Oa={key:0,class:"mt-2 rounded-xl bg-slate-50 p-3 text-sm text-slate-600"},qa={class:"mt-3 flex flex-wrap gap-2"},Wa=["disabled","onClick"],Ya=["disabled","onClick"],Ka={class:"w-full max-w-sm space-y-4 rounded-2xl bg-white p-6 shadow-2xl"},Ha={class:"space-y-1"},Qa={class:"text-sm text-slate-600"},Xa={class:"space-y-2"},Za=["href"],eo={key:0,class:"text-xs text-slate-500"},oo={__name:"JobDetail",setup(to){const fe=it(),x=at(),a=p(null),oe=p(!1),V=p(""),C=p([]),le=p(!1),z=p(""),g=p([]),$=p({submitted_total:0,approved_total:0,rejected_total:0}),ne=p(!1),G=p(""),m=me({description:"",amount:"",vat_rate:"20",receipt:null}),ie=p(0),D=p(""),I=p(!1),S=p(null),O=p(null),k=me({notes:"",proof:null}),_e=p(0),A=p(""),q=p(!1),L=p(!1),W=p(!1),f=me({sending:!1,error:"",lastUpdate:null}),Y=p(!1),B=p(!1),Ne=new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0});function E(s,e="GBP"){try{return new Intl.NumberFormat("en-GB",{style:"currency",currency:e||"GBP",maximumFractionDigits:2}).format(Number(s||0))}catch{return`${e} ${Number(s||0).toFixed(2)}`}}function U(s){if(!s)return"--";try{return new Intl.DateTimeFormat("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(new Date(s))}catch{return s}}function Re(s={}){return new Promise((e,o)=>{if(!navigator.geolocation){o(new Error("Geolocation is not supported on this device."));return}navigator.geolocation.getCurrentPosition(e,o,s)})}async function $e(){var s,e;if(a.value){f.error="",f.sending=!0;try{const d=(await Re({enableHighAccuracy:!0,maximumAge:3e4,timeout:15e3})).coords||{},b={latitude:d.latitude,longitude:d.longitude,accuracy:d.accuracy??void 0,heading:d.heading??void 0,speed_kph:typeof d.speed=="number"&&!Number.isNaN(d.speed)?Math.max(d.speed*3.6,0):void 0,source:"web"};if(b.latitude===void 0||b.longitude===void 0)throw new Error("Unable to determine your current position.");const v=await ut(a.value.id,b);v!=null&&v.job&&(a.value={...a.value,current_latitude:v.job.current_latitude,current_longitude:v.job.current_longitude,last_tracked_at:v.job.last_tracked_at},f.lastUpdate=v.job.last_tracked_at),Y.value=!0}catch(o){console.error("Failed to share live location",o),f.error=(o==null?void 0:o.message)||((e=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:e.message)||"We could not determine your current location. Please try again."}finally{f.sending=!1}}}function re(){Y.value=!1}function de(){m.description="",m.amount="",m.vat_rate="20",m.receipt=null,D.value="",S.value=null,ie.value+=1}function ge(){k.notes="",k.proof=null,A.value="",_e.value+=1}function F(s){const e={submitted_total:0,approved_total:0,rejected_total:0};s.forEach(o=>{const d=Number((o==null?void 0:o.total_amount)??0);o.status==="submitted"?e.submitted_total+=d:o.status==="approved"?e.approved_total+=d:o.status==="rejected"&&(e.rejected_total+=d)}),$.value=e}function Be(){if(!a.value){g.value=[],F([]);return}Array.isArray(a.value.expenses)?g.value=a.value.expenses:g.value=[],a.value.expenses_summary?$.value={submitted_total:Number(a.value.expenses_summary.submitted_total??0),approved_total:Number(a.value.expenses_summary.approved_total??0),rejected_total:Number(a.value.expenses_summary.rejected_total??0)}:F(g.value)}async function K(){if(!a.value||!M.value){g.value=[],F([]);return}ne.value=!0,G.value="";try{const s=await gt(a.value.id),e=Array.isArray(s==null?void 0:s.data)?s.data:[];g.value=e,F(e)}catch(s){console.error("Failed to load expenses",s),G.value="Unable to load expenses right now.",g.value=[],F([])}finally{ne.value=!1}}const j=c(()=>{var s;return((s=a.value)==null?void 0:s.assigned_to)??null}),H=c(()=>{var s;return x.role??((s=x.user)==null?void 0:s.role)??null}),Q=c(()=>{var e;if(!((e=a.value)!=null&&e.goes_live_at))return null;const s=new Date(a.value.goes_live_at);return Number.isNaN(s.getTime())?null:s}),Je=c(()=>Q.value?Q.value.getTime()>Date.now():!1),Pe=c(()=>Q.value?new Intl.DateTimeFormat("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(Q.value):""),J=c(()=>{var s;return((s=a.value)==null?void 0:s.basic_analytics)??null}),ye=c(()=>{var s;return f.lastUpdate??((s=a.value)==null?void 0:s.last_tracked_at)??null}),he=c(()=>ye.value?U(ye.value):""),Me=c(()=>{if(!a.value||!x.user)return!1;const s=new Set(["in_progress","collected","in_transit","accepted"]);return a.value.assigned_to_id===x.user.id&&s.has(String(a.value.status||"").toLowerCase())}),we=c(()=>a.value?[a.value.dropoff_label,a.value.dropoff_postcode].filter(Boolean).join(", "):""),ke=c(()=>{const s=we.value;if(!s)return[];const e=encodeURIComponent(s);return[{id:"google",label:"Open in Google Maps",href:`https://www.google.com/maps/dir/?api=1&destination=${e}&travelmode=driving`},{id:"waze",label:"Open in Waze",href:`https://waze.com/ul?q=${e}&navigate=yes`}]}),Ve=c(()=>{if(!a.value)return"";const s=String(a.value.status||"").toLowerCase();return s==="open"?"This job is open and awaiting driver applications.":["pending","accepted","in_progress","collected","in_transit"].includes(s)?j.value?`This job is currently in progress with ${j.value.name}.`:"This job is being prepared and will be assigned shortly.":s==="completion_pending"?"Completion has been submitted and is awaiting dealer approval.":["delivered","completed","closed"].includes(s)?j.value?`This job was completed by ${j.value.name}.`:"This job has been completed.":s==="cancelled"?"This job has been cancelled.":`This job status is ${a.value.status}.`}),ue=c(()=>!a.value||!x.user?!1:H.value==="admin"?!0:a.value.posted_by_id===x.user.id),T=c(()=>!a.value||!x.user?!1:a.value.posted_by_id===x.user.id),P=c(()=>!a.value||!x.user?!1:a.value.assigned_to_id===x.user.id),M=c(()=>!a.value||!x.token?!1:H.value==="admin"?!0:T.value||P.value),ze=c(()=>{var s;return!M.value||!P.value?!1:!((s=a.value)!=null&&s.finalized_invoice_id)}),je=c(()=>M.value?H.value==="admin"||T.value:!1),Ge=c(()=>T.value&&Je.value),ce=c(()=>{var s;return((s=a.value)==null?void 0:s.completion_status)??"not_submitted"}),Ce=c(()=>{var s;return P.value?!((s=a.value)!=null&&s.finalized_invoice_id):!1}),De=c(()=>H.value==="admin"||T.value?ce.value==="submitted":!1),Se=c(()=>{var s;return!!((s=a.value)!=null&&s.delivery_proof_path)}),pe=c(()=>{var s;return!!((s=a.value)!=null&&s.finalized_invoice_id)}),Le=c(()=>{if(!a.value||!T.value)return!1;const s=String(a.value.status||"").toLowerCase();return pe.value?!1:new Set(["accepted","in_progress","collected","in_transit","delivered","completion_pending"]).has(s)}),N=c(()=>{var s;return((s=a.value)==null?void 0:s.my_application)??null}),Ie=c(()=>{var e,o;const s=(((e=a.value)==null?void 0:e.transport_type)||"").toString().toLowerCase();return s==="drive_away"?"Drive-away":s==="trailer"?"Trailer":((o=a.value)==null?void 0:o.transport_type)||"--"});async function w(){var e;const s=fe.params.id;if(!s){a.value=null;return}oe.value=!0,V.value="";try{const o=await rt(s);a.value=(o==null?void 0:o.data)??o??null,Be(),f.lastUpdate=((e=a.value)==null?void 0:e.last_tracked_at)??null}catch(o){console.error("Failed to load job",o),V.value="We could not load this job.",a.value=null,g.value=[],F([]),f.lastUpdate=null}finally{oe.value=!1}if(!a.value){C.value=[];return}await Fe(),M.value?await K():(g.value=[],F([]))}async function Fe(){if(!a.value||!ue.value){C.value=[];return}le.value=!0,z.value="";try{const s=await _t(a.value.id);C.value=Array.isArray(s==null?void 0:s.data)?s.data:[]}catch(s){console.error("Failed to load applications",s),z.value="Unable to load applications right now.",C.value=[]}finally{le.value=!1}}async function Ae(s,e){var o,d;if(a.value)try{await ft(a.value.id,s,{status:e}),await w(),await Fe()}catch(b){console.error("Failed to update application",b),alert(((d=(o=b.response)==null?void 0:o.data)==null?void 0:d.message)||"Unable to update application. Please try again.")}}function Oe(s){var o;const[e]=((o=s.target)==null?void 0:o.files)??[];m.receipt=e??null}function qe(s){S.value=s.id,m.description=s.description??"",m.amount=s.amount??"",m.vat_rate=s.vat_rate??"20",m.receipt=null,D.value="",ie.value+=1}function We(){de()}async function Ye(){var s,e,o;if(a.value){if(!((s=m.description)!=null&&s.trim())||m.amount===""){D.value="Description and amount are required.";return}I.value=!0,D.value="";try{const d={description:m.description,amount:m.amount,vat_rate:m.vat_rate,receipt:m.receipt??void 0};S.value?await yt(a.value.id,S.value,d):await ht(a.value.id,d),de(),await K(),await w()}catch(d){console.error("Failed to save expense",d),D.value=((o=(e=d.response)==null?void 0:e.data)==null?void 0:o.message)||"Unable to save expense."}finally{I.value=!1}}}async function Ke(s){var e,o;if(!(!a.value||!(s!=null&&s.id))&&window.confirm("Delete this expense?"))try{await pt(a.value.id,s.id),await K(),await w()}catch(d){console.error("Failed to delete expense",d),alert(((o=(e=d.response)==null?void 0:e.data)==null?void 0:o.message)||"Unable to delete this expense.")}}async function Ee(s,e){var d,b;if(!a.value||!(s!=null&&s.id))return;const o=window.prompt("Add a note for the driver (optional)","");if(o!==null)try{await mt(a.value.id,s.id,{decision:e,note:o}),await K(),await w()}catch(v){console.error("Failed to review expense",v),alert(((b=(d=v.response)==null?void 0:d.data)==null?void 0:b.message)||"Unable to update this expense.")}}async function He(s){var e;if(!(!a.value||!(s!=null&&s.id))){O.value=s.id;try{const o=await ct(a.value.id,s.id),d=((e=o.headers)==null?void 0:e["content-type"])||"application/octet-stream",b=d.includes("pdf")?"pdf":d.includes("png")?"png":d.includes("jpeg")||d.includes("jpg")?"jpg":"bin",v=new Blob([o.data],{type:d}),y=window.URL.createObjectURL(v),i=(s.description||"receipt").toString().replace(/[^a-z0-9]+/gi,"-").toLowerCase(),h=document.createElement("a");h.href=y,h.download=`${i||"receipt"}-${s.id}.${b}`,document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(y)}catch(o){console.error("Failed to download receipt",o),alert("We could not download the receipt.")}finally{O.value=null}}}function Qe(s){var o;const[e]=((o=s.target)==null?void 0:o.files)??[];k.proof=e??null}async function Xe(){var s,e;if(a.value){if(!k.proof){A.value="Please upload delivery proof before submitting.";return}q.value=!0,A.value="";try{await wt(a.value.id,{notes:k.notes,proof:k.proof}),ge(),await w()}catch(o){console.error("Failed to submit completion",o),A.value=((e=(s=o.response)==null?void 0:s.data)==null?void 0:e.message)||"Unable to submit completion."}finally{q.value=!1}}}async function Ze(){var s,e;if(a.value){L.value=!0;try{await bt(a.value.id),await w()}catch(o){console.error("Failed to approve completion",o),alert(((e=(s=o.response)==null?void 0:s.data)==null?void 0:e.message)||"Unable to approve completion.")}finally{L.value=!1}}}async function et(){var e,o;if(!a.value)return;const s=window.prompt("Add a note for the driver (optional)","");if(s!==null){L.value=!0;try{await xt(a.value.id,{reason:s}),await w()}catch(d){console.error("Failed to reject completion",d),alert(((o=(e=d.response)==null?void 0:e.data)==null?void 0:o.message)||"Unable to reject completion.")}finally{L.value=!1}}}async function tt(){var e,o;if(!(!a.value||!Le.value||B.value||!window.confirm("Mark this job as completed and issue the invoice? This will notify the driver."))){B.value=!0;try{const d=await dt(a.value.id);d!=null&&d.job?a.value=d.job:await w()}catch(d){console.error("Failed to complete job as dealer",d),alert(((o=(e=d.response)==null?void 0:e.data)==null?void 0:o.message)||"Unable to mark this job as completed.")}finally{B.value=!1}}}async function st(){var s;if(a.value){W.value=!0;try{const e=await vt(a.value.id),o=((s=e.headers)==null?void 0:s["content-type"])||"application/octet-stream",d=o.includes("pdf")?"pdf":o.includes("png")?"png":o.includes("jpeg")||o.includes("jpg")?"jpg":"bin",b=new Blob([e.data],{type:o}),v=window.URL.createObjectURL(b),y=document.createElement("a");y.href=v,y.download=`job-${a.value.id}-proof.${d}`,document.body.appendChild(y),y.click(),document.body.removeChild(y),window.URL.revokeObjectURL(v)}catch(e){console.error("Failed to download delivery proof",e),alert("We could not download the delivery proof.")}finally{W.value=!1}}}return ot(async()=>{!x.user&&x.token&&await x.fetchMe().catch(()=>null),await w()}),Ue(()=>fe.params.id,()=>{de(),ge(),w()}),Ue(()=>{var s;return(s=a.value)==null?void 0:s.last_tracked_at},s=>{s&&(f.lastUpdate=s)}),(s,e)=>{var o,d,b,v,y;return l(),n("div",kt,[ve(Z(be),{to:"/jobs",class:"text-sm font-semibold text-emerald-600 hover:underline"},{default:X(()=>[...e[5]||(e[5]=[_(" Back to jobs ",-1)])]),_:1}),oe.value?(l(),n("div",jt," Loading job... ")):V.value?(l(),n("div",Ct,r(V.value),1)):a.value?(l(),n("div",St,[t("header",Lt,[t("div",null,[t("h1",Ft,r(a.value.title||`Job #${a.value.id}`),1),t("p",At,r(a.value.company||"Customer")+" - "+r(a.value.vehicle_make||"Vehicle"),1)]),t("div",Et,[t("div",Ut,r(Z(Ne).format(Number(a.value.price??0))),1),t("div",Tt,r(a.value.status),1)])]),Ge.value?(l(),n("section",Nt,[t("div",Rt,[e[7]||(e[7]=t("span",null,"Scheduled to go live soon",-1)),T.value?(l(),lt(Z(be),{key:0,to:{name:"job-edit",params:{id:a.value.id}},class:"inline-flex items-center gap-2 rounded-xl border border-amber-300 bg-white px-3 py-1 text-xs font-semibold text-amber-800 hover:bg-amber-100"},{default:X(()=>[...e[6]||(e[6]=[_(" Edit job ",-1),t("span",{"aria-hidden":"true"},"→",-1)])]),_:1},8,["to"])):u("",!0)]),t("p",$t,[e[8]||(e[8]=_(" This job will become visible to drivers at ",-1)),t("strong",null,r(Pe.value),1),e[9]||(e[9]=_(". You can still make changes for the next few minutes before it publishes. ",-1))])])):u("",!0),t("section",Bt,[t("div",Jt,[e[10]||(e[10]=t("h2",{class:"text-sm font-semibold uppercase tracking-wide text-slate-500"},"Pickup",-1)),t("p",Pt,r(a.value.pickup_label||"Pickup location"),1),t("p",Mt,r(a.value.pickup_postcode||"--"),1),t("p",Vt,r(a.value.pickup_notes||"No pickup notes provided."),1)]),t("div",zt,[e[11]||(e[11]=t("h2",{class:"text-sm font-semibold uppercase tracking-wide text-slate-500"},"Drop-off",-1)),t("p",Gt,r(a.value.dropoff_label||"Drop-off location"),1),t("p",It,r(a.value.dropoff_postcode||"--"),1),t("p",Ot,r(a.value.dropoff_notes||"No delivery notes provided."),1)]),t("div",qt,[t("div",Wt,[e[12]||(e[12]=t("span",{class:"text-sm font-semibold text-slate-500"},"Distance",-1)),t("span",Yt,r(a.value.distance_mi?`${a.value.distance_mi} mi`:"--"),1)]),t("div",Kt,[e[13]||(e[13]=t("span",{class:"text-sm font-semibold text-slate-500"},"Transport type",-1)),t("span",Ht,r(Ie.value),1)]),t("div",Qt,[e[14]||(e[14]=t("span",{class:"text-sm font-semibold text-slate-500"},"Created",-1)),t("span",Xt,r(a.value.created_at?new Date(a.value.created_at).toLocaleString():"--"),1)])])]),t("section",Zt,[e[17]||(e[17]=t("h2",{class:"text-sm font-semibold uppercase tracking-wide text-slate-500"},"Status",-1)),t("p",es,r(Ve.value),1),t("div",ts,[e[15]||(e[15]=t("label",{class:"text-xs font-semibold uppercase tracking-wide text-slate-500",for:"job-driver-select"}," Assigned driver ",-1)),t("select",ss,[j.value?(l(),n("option",{key:0,value:j.value.id},r(j.value.name)+" ("+r(j.value.email)+") ",9,as)):(l(),n("option",os," No driver assigned "))])]),Le.value?(l(),n("div",ls,[e[16]||(e[16]=t("div",{class:"flex-1"},[t("p",{class:"font-semibold text-emerald-900"},"Destination reached?"),t("p",null,"Mark this job as completed and trigger the driver invoice.")],-1)),t("button",{type:"button",class:"rounded-xl bg-emerald-600 px-4 py-2 text-xs font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",disabled:B.value,onClick:tt},[B.value?(l(),n("span",is,"Processing...")):(l(),n("span",rs,"Mark job completed"))],8,ns)])):u("",!0)]),Me.value?(l(),n("section",ds,[e[18]||(e[18]=t("header",{class:"space-y-1"},[t("h2",{class:"text-sm font-semibold uppercase tracking-wide text-slate-500"},"Live tracking"),t("p",{class:"text-xs text-slate-500"}," Share your current position with the dealer and launch navigation for the drop-off. ")],-1)),t("div",us,[t("button",{type:"button",class:"rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-700 disabled:cursor-not-allowed disabled:bg-emerald-300",disabled:f.sending,onClick:$e},[f.sending?(l(),n("span",ps,"Sharing location…")):(l(),n("span",ms,"Share live location"))],8,cs),t("button",{type:"button",class:"rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50",onClick:e[0]||(e[0]=i=>Y.value=!0)}," Open navigation apps ")]),f.error?(l(),n("p",vs,r(f.error),1)):u("",!0),he.value?(l(),n("p",bs," Last shared: "+r(he.value),1)):u("",!0)])):u("",!0),J.value?(l(),n("section",xs,[t("header",fs,[e[19]||(e[19]=t("div",null,[t("h2",{class:"text-sm font-semibold uppercase tracking-wide text-slate-500"},"Basic analytics"),t("p",{class:"text-xs text-slate-500"},"Snapshot of views generated while this job is live.")],-1)),t("span",_s,r(J.value.views_last_7_days)+" this week ",1)]),t("div",gs,[t("div",null,[e[20]||(e[20]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-500"},"Views today",-1)),t("p",ys,r(J.value.views_today),1)]),t("div",null,[e[21]||(e[21]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-500"},"Last 7 days",-1)),t("p",hs,r(J.value.views_last_7_days),1)]),t("div",null,[e[22]||(e[22]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-500"},"Daily log",-1)),t("ul",ws,[(l(!0),n(ee,null,te(J.value.daily,i=>(l(),n("li",{key:i.date},r(new Date(i.date).toLocaleDateString())+" - "+r(i.views)+" views ",1))),128))])])])])):u("",!0),M.value?(l(),n("section",ks,[t("header",js,[e[26]||(e[26]=t("div",null,[t("h2",{class:"text-sm font-semibold uppercase tracking-wide text-slate-500"},"Expenses"),t("p",{class:"text-xs text-slate-500"}," Track expense submissions and approvals for this job. ")],-1)),t("div",Cs,[t("span",null,[e[23]||(e[23]=_(" Submitted: ",-1)),t("span",Ds,r(E($.value.submitted_total)),1)]),t("span",null,[e[24]||(e[24]=_(" Approved: ",-1)),t("span",Ss,r(E($.value.approved_total)),1)]),t("span",null,[e[25]||(e[25]=_(" Rejected: ",-1)),t("span",Ls,r(E($.value.rejected_total)),1)])])]),G.value?(l(),n("p",Fs,r(G.value),1)):u("",!0),ze.value?(l(),n("form",{key:1,class:"grid gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 md:grid-cols-4",onSubmit:xe(Ye,["prevent"])},[t("div",As,[e[27]||(e[27]=t("label",{class:"block text-xs font-semibold uppercase tracking-wide text-slate-500"},"Description",-1)),se(t("input",{"onUpdate:modelValue":e[1]||(e[1]=i=>m.description=i),type:"text",required:"",class:"mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm",placeholder:"Taxi from auction"},null,512),[[ae,m.description]])]),t("div",null,[e[28]||(e[28]=t("label",{class:"block text-xs font-semibold uppercase tracking-wide text-slate-500"},"Amount",-1)),se(t("input",{"onUpdate:modelValue":e[2]||(e[2]=i=>m.amount=i),type:"number",min:"0",step:"0.01",required:"",class:"mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm",placeholder:"32.00"},null,512),[[ae,m.amount]])]),t("div",null,[e[29]||(e[29]=t("label",{class:"block text-xs font-semibold uppercase tracking-wide text-slate-500"},"VAT %",-1)),se(t("input",{"onUpdate:modelValue":e[3]||(e[3]=i=>m.vat_rate=i),type:"number",min:"0",step:"0.5",class:"mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"},null,512),[[ae,m.vat_rate]])]),t("div",Es,[e[30]||(e[30]=t("label",{class:"block text-xs font-semibold uppercase tracking-wide text-slate-500"},"Receipt",-1)),(l(),n("input",{key:ie.value,type:"file",accept:".jpg,.jpeg,.png,.pdf",class:"mt-1 w-full text-sm text-slate-600",onChange:Oe},null,32)),e[31]||(e[31]=t("p",{class:"mt-1 text-xs text-slate-500"},"Images or PDF up to 5 MB.",-1))]),t("div",Us,[S.value?(l(),n("button",{key:0,type:"button",class:"rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-100",onClick:We}," Cancel ")):u("",!0),t("button",{type:"submit",class:"rounded-xl bg-emerald-600 px-4 py-2 text-xs font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",disabled:I.value},[I.value?(l(),n("span",Ns,r(S.value?"Updating...":"Saving..."),1)):(l(),n("span",Rs,r(S.value?"Update expense":"Add expense"),1))],8,Ts)]),D.value?(l(),n("p",$s,r(D.value),1)):u("",!0)],32)):u("",!0),ne.value?(l(),n("div",Bs," Loading expenses... ")):g.value.length?(l(),n("div",Ps,[(l(!0),n(ee,null,te(g.value,i=>{var h;return l(),n("article",{key:i.id,class:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm"},[t("div",Ms,[t("div",null,[t("p",Vs,r(i.description),1),t("p",zs,[_(" Submitted "+r(U(i.submitted_at))+" ",1),(h=i.driver)!=null&&h.name?(l(),n("span",Gs," - "+r(i.driver.name),1)):u("",!0)])]),t("span",{class:Te(["badge",{"bg-emerald-100 text-emerald-700":i.status==="approved","bg-amber-100 text-amber-700":i.status==="submitted","bg-rose-100 text-rose-700":i.status==="rejected"}])},r(i.status),3)]),t("dl",Is,[t("div",null,[e[32]||(e[32]=t("dt",{class:"uppercase tracking-wide"},"Net",-1)),t("dd",Os,r(E(i.amount)),1)]),t("div",null,[t("dt",qs,"VAT ("+r(i.vat_rate)+"%)",1),t("dd",Ws,r(E(i.vat_amount)),1)]),t("div",null,[e[33]||(e[33]=t("dt",{class:"uppercase tracking-wide"},"Total",-1)),t("dd",Ys,r(E(i.total_amount)),1)])]),i.review_note?(l(),n("p",Ks," Dealer note: "+r(i.review_note),1)):u("",!0),t("div",Hs,[i.receipt_path?(l(),n("button",{key:0,type:"button",class:"rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-60",disabled:O.value===i.id,onClick:R=>He(i)},[O.value===i.id?(l(),n("span",Xs,"Downloading...")):(l(),n("span",Zs,"Receipt"))],8,Qs)):u("",!0),P.value&&i.is_editable?(l(),n("button",{key:1,type:"button",class:"rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50",onClick:R=>qe(i)}," Edit ",8,ea)):u("",!0),P.value&&i.is_editable?(l(),n("button",{key:2,type:"button",class:"rounded-xl border border-rose-200 px-3 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-50",onClick:R=>Ke(i)}," Delete ",8,ta)):u("",!0),je.value&&i.status==="submitted"?(l(),n("button",{key:3,type:"button",class:"rounded-xl border border-emerald-200 px-3 py-2 text-xs font-semibold text-emerald-700 hover:bg-emerald-50",onClick:R=>Ee(i,"approved")}," Approve ",8,sa)):u("",!0),je.value&&i.status==="submitted"?(l(),n("button",{key:4,type:"button",class:"rounded-xl border border-rose-200 px-3 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-50",onClick:R=>Ee(i,"rejected")}," Reject ",8,aa)):u("",!0)])])}),128))])):(l(),n("div",Js," No expenses submitted yet. "))])):u("",!0),Ce.value||De.value||ce.value!=="not_submitted"||Se.value||pe.value?(l(),n("section",oa,[t("header",la,[e[34]||(e[34]=t("div",null,[t("h2",{class:"text-sm font-semibold uppercase tracking-wide text-slate-500"},"Job completion"),t("p",{class:"text-xs text-slate-500"}," Drivers submit delivery proof and dealers approve to trigger invoices. ")],-1)),t("span",na,r(ce.value),1)]),t("div",ia,[t("div",null,[e[35]||(e[35]=t("span",{class:"font-semibold text-slate-500 uppercase tracking-wide"},"Submitted",-1)),t("p",ra,r(U((o=a.value)==null?void 0:o.completion_submitted_at)),1)]),t("div",null,[e[36]||(e[36]=t("span",{class:"font-semibold text-slate-500 uppercase tracking-wide"},"Approved",-1)),t("p",da,r(U((d=a.value)==null?void 0:d.completion_approved_at)),1)]),t("div",null,[e[37]||(e[37]=t("span",{class:"font-semibold text-slate-500 uppercase tracking-wide"},"Rejected",-1)),t("p",ua,r(U((b=a.value)==null?void 0:b.completion_rejected_at)),1)]),t("div",null,[e[38]||(e[38]=t("span",{class:"font-semibold text-slate-500 uppercase tracking-wide"},"Notes",-1)),t("p",ca,r(((v=a.value)==null?void 0:v.completion_notes)||"--"),1)])]),A.value?(l(),n("p",pa,r(A.value),1)):u("",!0),Ce.value?(l(),n("form",{key:1,class:"grid gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 md:grid-cols-2",onSubmit:xe(Xe,["prevent"])},[t("div",ma,[e[39]||(e[39]=t("label",{class:"block text-xs font-semibold uppercase tracking-wide text-slate-500"},"Notes for dealer",-1)),se(t("textarea",{"onUpdate:modelValue":e[4]||(e[4]=i=>k.notes=i),rows:"2",class:"mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm",placeholder:"Delivered at 17:45, keys left with reception"},null,512),[[ae,k.notes]])]),t("div",va,[e[40]||(e[40]=t("label",{class:"block text-xs font-semibold uppercase tracking-wide text-slate-500"},"Delivery proof",-1)),(l(),n("input",{key:_e.value,type:"file",accept:".jpg,.jpeg,.png,.pdf",class:"mt-1 w-full text-sm text-slate-600",required:"",onChange:Qe},null,32)),e[41]||(e[41]=t("p",{class:"mt-1 text-xs text-slate-500"},"Upload POD images or a signed PDF up to 8 MB.",-1))]),t("div",ba,[t("button",{type:"submit",class:"rounded-xl bg-emerald-600 px-4 py-2 text-xs font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",disabled:q.value},[q.value?(l(),n("span",fa,"Submitting...")):(l(),n("span",_a,"Submit completion"))],8,xa)])],32)):u("",!0),Se.value?(l(),n("div",ga,[t("div",null,[e[42]||(e[42]=t("span",{class:"font-semibold text-slate-500 uppercase tracking-wide"},"Delivery proof",-1)),t("p",ya," Uploaded "+r(U((y=a.value)==null?void 0:y.completion_submitted_at)),1)]),t("button",{type:"button",class:"rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-100 disabled:opacity-60",disabled:W.value,onClick:st},[W.value?(l(),n("span",wa,"Downloading...")):(l(),n("span",ka,"Download proof"))],8,ha)])):u("",!0),De.value?(l(),n("div",ja,[t("button",{type:"button",class:"rounded-xl bg-emerald-600 px-4 py-2 text-xs font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",disabled:L.value,onClick:Ze},[L.value?(l(),n("span",Da,"Processing...")):(l(),n("span",Sa,"Approve completion"))],8,Ca),t("button",{type:"button",class:"rounded-xl border border-rose-200 px-4 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-50 disabled:opacity-60",disabled:L.value,onClick:et}," Request changes ",8,La)])):u("",!0),pe.value?(l(),n("div",Fa,[e[44]||(e[44]=_(" Invoice finalised. ",-1)),ve(Z(be),{to:"/invoices",class:"font-semibold text-emerald-800 underline"},{default:X(()=>[...e[43]||(e[43]=[_("View invoices",-1)])]),_:1})])):u("",!0)])):u("",!0),N.value&&!ue.value?(l(),n("section",Aa,[e[46]||(e[46]=t("h2",{class:"text-sm font-semibold uppercase tracking-wide text-slate-500"},"Your application",-1)),t("p",Ea,[e[45]||(e[45]=_(" Status: ",-1)),t("span",Ua,r(N.value.status),1),N.value.responded_at?(l(),n("span",Ta," (updated "+r(new Date(N.value.responded_at).toLocaleString())+") ",1)):u("",!0)]),N.value.message?(l(),n("p",Na," Your note: "+r(N.value.message),1)):u("",!0),e[47]||(e[47]=t("p",{class:"text-xs text-slate-500"}," The dealer will review applications and confirm the assignment. You will be notified when selected. ",-1))])):u("",!0),ue.value?(l(),n("section",Ra,[t("header",$a,[e[48]||(e[48]=t("div",null,[t("h2",{class:"text-sm font-semibold uppercase tracking-wide text-slate-500"},"Driver applications"),t("p",{class:"text-xs text-slate-500"}," Review pending applications and choose a driver. The selected driver will receive messaging access. ")],-1)),t("span",Ba,r(C.value.length)+" total",1)]),le.value?(l(),n("div",Ja," Loading applications... ")):z.value?(l(),n("div",Pa,r(z.value),1)):C.value.length?(l(),n("div",Va,[(l(!0),n(ee,null,te(C.value,i=>{var h;return l(),n("article",{key:i.id,class:"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm"},[t("div",za,[t("div",null,[t("p",Ga,r(((h=i.driver)==null?void 0:h.name)||"Driver"),1),t("p",Ia," Applied "+r(new Date(i.created_at).toLocaleString()),1)]),t("span",{class:Te(["badge",{"bg-emerald-100 text-emerald-700":i.status==="accepted","bg-amber-100 text-amber-700":i.status==="pending","bg-slate-200 text-slate-700":i.status==="declined"}])},r(i.status),3)]),i.message?(l(),n("p",Oa,' "'+r(i.message)+'" ',1)):u("",!0),t("div",qa,[t("button",{type:"button",class:"rounded-xl border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-60",disabled:i.status!=="pending",onClick:R=>Ae(i.id,"declined")}," Decline ",8,Wa),t("button",{type:"button",class:"rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-60",disabled:i.status!=="pending",onClick:R=>Ae(i.id,"accepted")}," Accept and assign ",8,Ya)])])}),128))])):(l(),n("div",Ma," No driver applications yet. "))])):u("",!0)])):(l(),n("div",Dt," Job not found. ")),ve(nt,{name:"fade"},{default:X(()=>[Y.value?(l(),n("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 px-4",onClick:xe(re,["self"])},[t("div",Ka,[t("header",Ha,[e[49]||(e[49]=t("h3",{class:"text-lg font-semibold text-slate-900"},"Navigation",-1)),t("p",Qa," Choose an app to start directions to "+r(we.value||"the drop-off location")+". ",1)]),t("div",Xa,[(l(!0),n(ee,null,te(ke.value,i=>(l(),n("a",{key:i.id,href:i.href,target:"_blank",rel:"noopener",class:"flex items-center justify-between rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50",onClick:re},[_(r(i.label)+" ",1),e[50]||(e[50]=t("span",{"aria-hidden":"true"},"↗",-1))],8,Za))),128)),ke.value.length?u("",!0):(l(),n("p",eo," We could not determine a destination for this job yet. "))]),t("button",{type:"button",class:"w-full rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50",onClick:re}," Close ")])])):u("",!0)]),_:1})])}}};export{oo as default};
